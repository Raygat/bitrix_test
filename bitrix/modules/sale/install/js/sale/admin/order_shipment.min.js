BX.namespace("BX.Sale.Admin.OrderShipment");BX.Sale.Admin.OrderShipment=function(e){this.index=e.index;this.id=e.id;this.shipment_statuses=e.shipment_statuses;this.isAjax=!!e.isAjax;this.srcList=e.src_list;this.allowAvailable=!!e.canAllow;this.deductAvailable=!!e.canDeduct;this.changeStatusAvailable=!!e.canChangeStatus;this.discounts=e.discounts||{};this.discountsMode=e.discountsMode||"edit";if(this.allowAvailable)this.initFieldChangeAllowDelivery();if(this.deductAvailable)this.initFieldChangeDeducted();if(this.changeStatusAvailable)this.initFieldChangeStatus();if(!!e.active&&e.templateType=="view")this.initUpdateTrackingNumber();this.initFieldUpdateSum();this.initChangeProfile();this.initCustomEvent();this.initToggle();this.initDeleteShipment();if(this.discounts)this.setDiscountsList(this.discounts);var i=[];if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){i["DELIVERY_PRICE_DISCOUNT"]={callback:this.setDeliveryPrice,context:this}}if(!!e.calculated_price)this.setCalculatedPriceDelivery(e.calculated_price);i["DEDUCTED_"+this.id]={callback:this.updateDeductedStatus,context:this};i["ALLOW_DELIVERY_"+this.id]={callback:this.updateAllowDeliveryStatus,context:this};i["SHIPMENT_STATUS_LIST_"+this.id]={callback:this.setShipmentStatusList,context:this};i["SHIPMENT_STATUS_"+this.id]={callback:this.setDeliveryStatus,context:this};if(e.templateType=="edit"){i["BASE_PRICE_DELIVERY"]={callback:this.setDeliveryBasePrice,context:this};i["CALCULATED_PRICE"]={callback:this.setCalculatedPriceDelivery,context:this};i["DELIVERY_ERROR"]={callback:BX.Sale.Admin.OrderEditPage.showDialog,context:this};i["MAP"]={callback:this.updateMap,context:this};i["PROFILES"]={callback:this.updateProfiles,context:this};i["EXTRA_SERVICES"]={callback:this.updateExtraService,context:this};i["DELIVERY_SERVICE_LIST"]={callback:this.updateDeliveryList,context:this};i["SHIPMENT_COMPANY_ID"]={callback:this.updateCompany,context:this};if(!!BX.Sale.Admin.OrderBuyer&&!!BX.Sale.Admin.OrderBuyer.propertyCollection){var t=BX.Sale.Admin.OrderBuyer.propertyCollection.getDeliveryLocation();if(t){t.addEvent("change",function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData(),true)})}}}i["DISCOUNTS_LIST"]={callback:this.setDiscountsList,context:this};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(i)};BX.Sale.Admin.OrderShipment.prototype.updateCompany=function(e){var i=BX("SHIPMENT_COMPANY_ID_"+this.index);if(i)i.innerHTML=e};BX.Sale.Admin.OrderShipment.prototype.updateDeductedStatus=function(e){this.setDeducted({status:e})};BX.Sale.Admin.OrderShipment.prototype.updateAllowDeliveryStatus=function(e){this.setAllowDelivery({status:e})};BX.Sale.Admin.OrderShipment.prototype.initUpdateTrackingNumber=function(){var e="";var i=BX("TRACKING_NUMBER_"+this.index+"_EDIT");var t=BX("TRACKING_NUMBER_"+this.index+"_VIEW");var r=BX("TRACKING_NUMBER_PENCIL_"+this.index);if(r){BX.bind(r,"click",function(){BX.toggle(this);if(i){BX.toggle(i);BX.toggle(t);i.focus()}});BX.bind(i,"blur",BX.proxy(function(){BX.toggle(r);BX.toggle(i);t.innerHTML=i.value;BX.toggle(t);if(i.value!=e){var a={action:"saveTrackingNumber",orderId:BX("ID").value,shipmentId:BX("SHIPMENT_ID_"+this.index).value,trackingNumber:i.value};BX.Sale.Admin.OrderAjaxer.sendRequest(a)}},this));BX.bind(i,"focus",function(){e=i.value})}};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryList=function(e){var i=BX("DELIVERY_"+this.index);if(!i)return;var t=i.options[i.selectedIndex].value;i.innerHTML=e;for(var r in i.options){if(i.options[r].value==t){i.options[r].selected=true;break}}};BX.Sale.Admin.OrderShipment.prototype.setDiscountsList=function(e){this.discounts=e;var i=BX("sale-order-shipment-discounts-container-"+this.index),t=BX("sale-order-shipment-discounts-row-"+this.index),r="none";if(i){i=BX.cleanNode(i,false);if(e&&e.RESULT&&e.RESULT.DELIVERY&&e.RESULT.DELIVERY.length>0){i.appendChild(this.createDiscountsNode(e.RESULT.DELIVERY));r=""}}if(t&&t.previousElementSibling){t.style.display=r;t.previousElementSibling.style.display=r}};BX.Sale.Admin.OrderShipment.prototype.createDiscountsNode=function(e){return BX.Sale.Admin.OrderEditPage.createDiscountsNode("","DELIVERY",e,this.discounts,this.discountsMode=="edit"?"EDIT":"VIEW")};BX.Sale.Admin.OrderShipment.prototype.updateProfiles=function(e){var i=null;var t=BX("BLOCK_DELIVERY_SERVICE_"+this.index);var r=BX("BLOCK_PROFILES_"+this.index);var a=BX("PROFILE_"+this.index);if(a)i=a.options[a.selectedIndex].value;if(r)BX.remove(r);var n=BX.create("tr",{props:{id:"BLOCK_PROFILES_"+this.index},children:[BX.create("td",{text:BX.message("SALE_ORDER_SHIPMENT_PROFILE")+":",style:{width:"40%"},props:{className:"adm-detail-content-cell-l"}}),BX.create("td",{html:e,props:{id:" PROFILE_SELECT_"+this.index,className:"adm-detail-content-cell-r"}})]});t.parentNode.appendChild(n);a=n.lastChild.firstChild;if(i){for(var s in a.options){if(a.options[s].value==i){a.options[s].selected=true;break}}}BX.bind(a,"change",BX.proxy(function(){if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData());this.updateDeliveryLogotip()}else{this.updateDeliveryInfo()}},this))};BX.Sale.Admin.OrderShipment.prototype.updateExtraService=function(e){var i=BX("DELIVERY_INFO_"+this.index);i.innerHTML=e};BX.Sale.Admin.OrderShipment.prototype.updateShipmentStatus=function(e,i,t){var r={action:"updateShipmentStatus",orderId:BX("ID").value,shipmentId:BX("SHIPMENT_ID_"+this.index).value,field:e,status:i,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{this[t.callback](t.args);if(e.RESULT)BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT)}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(r)};BX.Sale.Admin.OrderShipment.prototype.updateMap=function(e){var i=BX.processHTML(e);var t=BX("section_map_"+this.index);t.innerHTML=i["HTML"];for(var r in i["SCRIPT"])BX.evalGlobal(i["SCRIPT"][r]["JS"]);BX.loadCSS(i["STYLE"])};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryLogotip=function(){var e=BX("DELIVERY_"+this.index);var i=BX.findParent(e,{tag:"tbody"},true);if(i.children.length>1)e=BX("PROFILE_"+this.index);var t="";var r="";var a=0;if(this.srcList[BX(e).value])a=BX(e).value;t=this.srcList[a]["MAIN"];r=this.srcList[a]["SHORT"];var n=BX("delivery_service_logo_"+this.index);if(!!n)n.style.background="url("+t+")";var s=BX("delivery_service_short_logo_"+this.index);if(!!s)s.style.background="url("+r+")"};BX.Sale.Admin.OrderShipment.prototype.initChangeProfile=function(){var e=BX("DELIVERY_"+this.index);BX.bind(e,"change",BX.proxy(function(){var i=BX("DELIVERY_INFO_"+this.index);i.innerHTML="";var t=BX("section_map_"+this.index);t.innerHTML="";var r=BX("BLOCK_PROFILES_"+this.index);if(r)BX.remove(r);var a=BX("sale-order-shipment-discounts-row-"+this.index);if(a){BX.hide(a.previousElementSibling);BX.hide(a)}var n=BX(e).value;if(n>0)this.updateDeliveryInfo();else this.setDeliveryPrice(0)},this));var i=BX("PROFILE_"+this.index);if(i){BX.bind(i,"change",BX.proxy(function(){var e=BX("DELIVERY_INFO_"+this.index);e.innerHTML="";var t=BX("section_map_"+this.index);t.innerHTML="";var r=BX("sale-order-shipment-discounts-row-"+this.index);if(r){BX.hide(r.previousElementSibling);BX.hide(r)}var a=BX(i).value;if(a>0)this.updateDeliveryInfo();else this.setDeliveryPrice(0)},this))}};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeDeducted=function(){var e=BX("STATUS_DEDUCTED_"+this.index);var i=["SHORT_"+this.index,this.index];for(var t in i){var r=BX("BUTTON_DEDUCTED_"+i[t]);if(!r)continue;var a=[];if(e.value=="N"){a.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_YES"),ONCLICK:BX.proxy(function(){var e={status:"Y"};if(this.isAjax)this.updateShipmentStatus("DEDUCTED","Y",{callback:"setDeducted",args:e});else this.setDeducted(e)},this)})}else{a.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_NO"),ONCLICK:BX.proxy(function(){var e={status:"N"};if(this.isAjax)this.updateShipmentStatus("DEDUCTED","N",{callback:"setDeducted",args:e});else this.setDeducted(e)},this)})}var n=new BX.COpener({DIV:r.parentNode,MENU:a})}};BX.Sale.Admin.OrderShipment.prototype.setDeducted=function(e){var i=e.status=="Y"?"YES":"NO";var t=BX("STATUS_DEDUCTED_"+this.index);var r=["SHORT_"+this.index,this.index];t.value=e.status;for(var a in r){var n=BX("BUTTON_DEDUCTED_"+r[a]);if(!n)continue;BX.html(n,BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_"+i));if(e.status=="Y")BX.removeClass(n,"notdeducted");else BX.addClass(n,"notdeducted")}this.initFieldChangeDeducted()};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeStatus=function(){var e=["SHORT_"+this.index,this.index];var i=BX("STATUS_SHIPMENT_"+this.index);for(var t in e){var r=BX("BUTTON_SHIPMENT_"+e[t]);var a=[];for(var n in this.shipment_statuses){if(this.shipment_statuses[n].ID==i.value)continue;function s(e,i){var t={name:e.NAME,id:e.ID};var r={TEXT:e.NAME,ONCLICK:function(){i.updateShipmentStatus("STATUS_ID",e.ID,{callback:"setDeliveryStatus",args:t})}};a.push(r)}s(this.shipment_statuses[n],this)}if(r){if(a.length>0){var d=new BX.COpener({DIV:r.parentNode,MENU:a})}else{var l=BX.create("span",{children:[BX.create("span",{attrs:{id:r.getAttribute("id"),className:"not_active"},text:r.textContent})]});r.parentNode.parentNode.appendChild(l);BX.remove(r.parentNode)}}}};BX.Sale.Admin.OrderShipment.prototype.setDeliveryStatus=function(e){var i=BX("STATUS_SHIPMENT_"+this.index);i.value=e.id;var t=["SHORT_"+this.index,this.index];for(var r in t){var a=BX("BUTTON_SHIPMENT_"+t[r]);BX.html(a,e.name)}this.initFieldChangeStatus()};BX.Sale.Admin.OrderShipment.prototype.setDeliveryBasePrice=function(e){if(!BX("BASE_PRICE_DELIVERY_"+this.index))return;if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form")BX("BASE_PRICE_DELIVERY_"+this.index).innerHTML=e;else this.setCalculatedPriceDelivery(e)};BX.Sale.Admin.OrderShipment.prototype.setDeliveryPrice=function(e){if(!BX("PRICE_DELIVERY_"+this.index))return;BX("PRICE_DELIVERY_"+this.index).value=e};BX.Sale.Admin.OrderShipment.prototype.setCalculatedPriceDelivery=function(e){var i=BX("CUSTOM_PRICE_DELIVERY_"+this.index);if(i.value!="Y"&&BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form")return;var t=BX("PRICE_DELIVERY_"+this.index);if(t){var r=BX.findParent(t,{tag:"tbody"},true);var a=BX.findChildByClassName(r,"row_set_new_delivery_price");if(a)BX.remove(a)}BX("CALCULATED_PRICE_"+this.index).value=e;var n=BX.create("tr",{children:[BX.create("td",{html:BX.message("SALE_ORDER_SHIPMENT_NEW_PRICE_DELIVERY")+": ",props:{className:"adm-detail-content-cell-l"}}),BX.create("td",{children:[BX.create("span",{text:BX.Sale.Admin.OrderEditPage.currencyFormat(e)}),BX.create("span",{text:BX.message("SALE_ORDER_SHIPMENT_APPLY"),props:{onclick:BX.proxy(function(){if(confirm(BX.message("SALE_ORDER_SHIPMENT_CONFIRM_SET_NEW_PRICE"))){BX("PRICE_DELIVERY_"+this.index).value=e;var t=BX.findChildByClassName(r,"row_set_new_delivery_price");BX.remove(t);i.value="N";if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form")BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}},this),className:"new_delivery_price_button"}})],props:{className:"adm-detail-content-cell-r"}})],props:{className:"row_set_new_delivery_price"}});r.appendChild(n)};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryInfo=function(){var e=BX.Sale.Admin.OrderEditPage.getAllFormData();var i={action:"changeDeliveryService",formData:e,index:this.index,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.SHIPMENT_DATA);this.updateDeliveryLogotip()}},this)};if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form")BX.Sale.Admin.OrderAjaxer.sendRequest(i,false,true);else BX.Sale.Admin.OrderAjaxer.sendRequest(i,false,false)};BX.Sale.Admin.OrderShipment.prototype.getDeliveryPrice=function(){var e=BX.Sale.Admin.OrderEditPage.getAllFormData();var i={action:"getDefaultDeliveryPrice",formData:e,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0)BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR);else BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT)},this)};var t=BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form";BX.Sale.Admin.OrderAjaxer.sendRequest(i,false,t)};BX.Sale.Admin.OrderShipment.prototype.initCustomEvent=function(){BX.addCustomEvent("onDeliveryExtraServiceValueChange",BX.proxy(function(e){if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}else{this.getDeliveryPrice()}},this))};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeAllowDelivery=function(){var e=BX("STATUS_ALLOW_DELIVERY_"+this.index);var i=["SHORT_"+this.index,this.index];for(var t in i){var r=BX("BUTTON_ALLOW_DELIVERY_"+i[t]);if(!r)continue;var a=[];if(e.value=="Y"){a.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_NO"),ONCLICK:BX.proxy(function(){var e={status:"N"};if(this.isAjax)this.updateShipmentStatus("ALLOW_DELIVERY","N",{callback:"setAllowDelivery",args:e});else this.setAllowDelivery(e)},this)})}else{a.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_YES"),ONCLICK:BX.proxy(function(){var e={status:"Y"};if(this.isAjax)this.updateShipmentStatus("ALLOW_DELIVERY","Y",{callback:"setAllowDelivery",args:e});else this.setAllowDelivery(e);this.initFieldChangeAllowDelivery()},this)})}var n=new BX.COpener({DIV:r.parentNode,MENU:a})}};BX.Sale.Admin.OrderShipment.prototype.setAllowDelivery=function(e){var i=e.status=="Y"?"YES":"NO";var t=["SHORT_"+this.index,this.index];var r=BX("STATUS_ALLOW_DELIVERY_"+this.index);r.value=e.status;for(var a in t){var n=BX("BUTTON_ALLOW_DELIVERY_"+t[a]);if(!n)continue;BX.html(n,BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_"+i));if(e.status=="Y")BX.removeClass(n,"notdelivery");else BX.addClass(n,"notdelivery")}this.initFieldChangeAllowDelivery()};BX.Sale.Admin.OrderShipment.prototype.setShipmentStatusList=function(e){this.shipment_statuses=e;this.initFieldChangeStatus()};BX.Sale.Admin.OrderShipment.prototype.initFieldUpdateSum=function(){var e=BX("PRICE_DELIVERY_"+this.index);var i=BX("CUSTOM_PRICE_DELIVERY_"+this.index);BX.bind(e,"change",BX.proxy(function(){i.value="Y";if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}else{var e=BX("sale-order-shipment-discounts-row-"+this.index);if(e){BX.hide(e.previousElementSibling);BX.hide(e)}BX("CUSTOM_PRICE_DELIVERY_"+this.index).value="Y"}},this))};BX.Sale.Admin.OrderShipment.prototype.initToggle=function(){var e=BX("SHIPMENT_SECTION_"+this.index);var i=BX("SHIPMENT_SECTION_SHORT_"+this.index);var t=BX("SHIPMENT_SECTION_"+this.index+"_TOGGLE");BX.bind(t,"click",BX.proxy(function(){t.innerHTML=i.style.display!="none"?BX.message("SALE_ORDER_SHIPMENT_BLOCK_SHIPMENT_TOGGLE"):BX.message("SALE_ORDER_SHIPMENT_BLOCK_SHIPMENT_TOGGLE_UP");BX.toggle(e);BX.toggle(i)},this))};BX.Sale.Admin.OrderShipment.prototype.initDeleteShipment=function(){var e=BX("SHIPMENT_SECTION_"+this.index+"_DELETE");BX.bind(e,"click",BX.proxy(function(){if(confirm(BX.message("SALE_ORDER_SHIPMENT_CONFIRM_DELETE_SHIPMENT"))){var e=BX("ID")?BX("ID").value:0;var i=BX("SHIPMENT_ID_"+this.index)?BX("SHIPMENT_ID_"+this.index).value:0;if(e>0&&i>0){var t={action:"deleteShipment",order_id:e,shipment_id:i,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT);BX.cleanNode(BX("shipment_container_"+this.index))}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(t)}}},this))};BX.namespace("BX.Sale.Admin.GeneralShipment");BX.Sale.Admin.GeneralShipment={getIds:function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())},createNewShipment:function(){var e=BX("ID").value;window.location="/bitrix/admin/sale_order_shipment_edit.php?lang="+BX.Sale.Admin.OrderEditPage.languageId+"&order_id="+e+"&backurl="+encodeURIComponent(window.location.pathname+window.location.search)},findProductByBarcode:function(e){BX.hide(e.parentNode);BX.show(e.parentNode.nextElementSibling)},refreshTrackingStatus:function(e,i,t){var r="";if(t){var a=BX("order_shipment_edit_info_form");if(a){var n=a.elements["SHIPMENT["+e+"][TRACKING_NUMBER]"];if(n&&n.value)r=n.value}}else{var s=BX("TRACKING_NUMBER_"+e+"_VIEW");if(s)r=s.innerHTML}if(!r){alert(BX.message("SALE_ORDER_SHIPMENT_TRACKING_S_EMPTY"));return}var d={action:"refreshTrackingStatus",shipmentId:i,trackingNumber:r,callback:function(i){if(i&&!i.ERROR){if(i.TRACKING_STATUS){var t=BX("sale-order-shipment-tracking-status-"+e);if(t)t.innerHTML=i.TRACKING_STATUS}if(i.TRACKING_DESCRIPTION){var r=BX("sale-order-shipment-tracking-description-"+e);if(r)r.innerHTML=i.TRACKING_DESCRIPTION}if(i.TRACKING_LAST_CHANGE){var a=BX("sale-order-shipment-tracking-last-change-"+e);if(a)a.innerHTML=i.TRACKING_LAST_CHANGE}}else if(i&&i.ERROR){BX.Sale.Admin.OrderEditPage.showDialog(i.ERROR)}else{BX.debug("Error refreshing tracking status!")}}};BX.Sale.Admin.OrderAjaxer.sendRequest(d)}};
//# sourceMappingURL=order_shipment.map.js